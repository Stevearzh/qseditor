var formDataURL="/post.php";var upConfig={Bucket:"qseditor",API:"hXTO2xagYw98S646UEyRh7BJ+DM=",Param:{expiration:(new Date().getTime())+60,"save-key":"/{year}/{mon}/{day}/upload_{filemd5}{.suffix}","allow-file-type":"jpg,jpeg,gif,png,bmp,svg"},Policy:function(){var a="";for(var b in upConfig.Param){a+='"'+b+'":';if(isNaN(upConfig.Param[b])){a+='"'+upConfig.Param[b]+'",'}else{a+=upConfig.Param[b]+","}}a=a.substring(0,a.length-1);return Base64.encode("{"+a+"}")},Signature:function(){var a=upConfig.Policy()+"&"+upConfig.API;return md5(a)}};upConfig.Param.bucket=upConfig.Bucket;upConfig.URL="//v0.api.upyun.com/"+upConfig.Bucket;upConfig.Host="//"+upConfig.Bucket+".b0.upaiyun.com";function $id(a){return document.getElementById(a)}function newRequest(){var f;if(typeof XMLHttpRequest!=="undefined"){f=new XMLHttpRequest()}else{var b=["MSXML2.XmlHttp.5.0","MSXML2.XmlHttp.4.0","MSXML2.XmlHttp.3.0","MSXML2.XmlHttp.2.0","Microsoft.XmlHttp"];for(var c=0,a=b.length;c<a;c++){try{f=new ActiveXObject(b[c]);break}catch(d){}}}return f}var qsemode;var qse={Mode:"markdown",Define:function(){var a=typeof HTMLElement!=="undefined"?HTMLElement.prototype:Element.prototype;Object.defineProperty(a,"hasClass",{writable:true,enumerable:true,configurable:true,value:function(b){return !!this.className.match(new RegExp("(\\s|^)"+b+"(\\s|$)"))}});Object.defineProperty(a,"addClass",{writable:true,enumerable:true,configurable:true,value:function(b){if(!this.hasClass(b)){this.className+=" "+b}}});Object.defineProperty(a,"removeClass",{writable:true,enumerable:true,configurable:true,value:function(c){if(this.hasClass(c)){var b=new RegExp("(\\s|^)"+c+"(\\s|$)");this.className=this.className.replace(b," ")}}});Object.defineProperty(a,"addNode",{writable:true,enumerable:true,configurable:true,value:function(d){var c;if(d.isTextNode){c=document.createTextNode(d.text)}else{c=document.createElement(d.nodeType);for(var b in d){if(d[b]){c[b]=d[b]}}if("sandbox" in c){c.sandbox=""}}this.appendChild(c);return c}})},Editor:function(){$id("qse").className="qse";$id("qse").addNode({nodeType:"div",className:"qse-nav",id:"qseNav"}).addNode({nodeType:"div",className:"qse-mode qse-md",id:"qseMd"}).addNode({isTextNode:true,text:"Markdown"});$id("qseNav").addNode({nodeType:"div",className:"qse-mode qse-bbc qse-mode-clear",id:"qseBBC"}).addNode({isTextNode:true,text:"BBCode"});$id("qseNav").addNode({nodeType:"div",className:"qse-action qse-preview-button",id:"qsePreviewButton"}).addNode({isTextNode:true,text:"预览"});$id("qse").addNode({nodeType:"div",className:"qse-face",id:"qseFace"}).addNode({nodeType:"div",className:"qse-main",id:"qseMain"}).addNode({nodeType:"textarea",className:"qse-area",id:"qseArea"});$id("qseMain").addNode({nodeType:"iframe",className:"qse-preview hidden",id:"qsePreview",sandbox:" ",security:"restricted"});$id("qseFace").addNode({nodeType:"button",className:"qse-submit",id:"qseSubmit"}).addNode({isTextNode:true,text:"提交"});$id("qseMain").addNode({nodeType:"form",className:"qse-img-uploader",id:"qseImgUploader",enctype:"multipart/form-data",method:"POST"}).addNode({nodeType:"fieldset",id:"innerUploader"}).addNode({nodeType:"input",className:"qse-img-uploader-hidden",id:"MAX_FILE_SIZE",name:"MAX_FILE_SIZE",type:"hidden",value:3000});$id("innerUploader").addNode({nodeType:"div",id:"innerDiv"}).addNode({nodeType:"input",className:"qse-img-uploader-drag",id:"qseFileSelect",multiple:"multiple",name:"fileselect[]",type:"file"});$id("innerDiv").addNode({nodeType:"div",className:"qse-img-uploader-information",id:"qseImgUploaderInfo"}).addNode({isTextNode:true,text:"拖动图片至此处，复制粘贴，或点击"});$id("qseImgUploaderInfo").addNode({nodeType:"span",className:"qse-img-uploader-click-here",id:"qseClickHere"}).addNode({isTextNode:true,text:"这里"});$id("qseImgUploaderInfo").addNode({isTextNode:true,text:"上传"})},MdMode:function(){$id("qseMd").removeClass("qse-mode-clear");$id("qseBBC").addClass("qse-mode-clear");$id("qsePreview").addClass("hidden");$id("qseArea").removeClass("hidden");$id("qseImgUploader").removeClass("hidden");qse.Mode="markdown";window.localStorage.setItem("qsemode","markdown")},BBCMode:function(){$id("qseBBC").removeClass("qse-mode-clear");$id("qseMd").addClass("qse-mode-clear");$id("qsePreview").addClass("hidden");$id("qseArea").removeClass("hidden");$id("qseImgUploader").removeClass("hidden");qse.Mode="bbcode";window.localStorage.setItem("qsemode","bbcode")},Switcher:function(){var a=$id("qseMd");var b=$id("qseBBC");a.onclick=function(){if(qse.Mode!=="markdown"){if(!$id("qseArea").value){qse.MdMode()}else{confirm("警告：切换标签会清除文本区中所有内容！是否继续？")?(function(){$id("qseArea").value="";qse.MdMode()})():""}}};b.onclick=function(){if(qse.Mode!=="bbcode"){if(!$id("qseArea").value){qse.BBCMode()}else{confirm("警告：切换标签会清除文本区中所有内容！是否继续？")?(function(){$id("qseArea").value="";qse.BBCMode()})():""}}}},GetContent:function(){switch(qse.Mode){case"markdown":return qse.Parser($id("qseArea").value);case"bbcode":return $id("qseArea").value;default:return $id("qseArea").value}},Previewer:function(){$id("qsePreviewButton").onclick=function(){if($id("qsePreview").hasClass("hidden")){$id("qsePreview").removeClass("hidden");$id("qseArea").addClass("hidden");$id("qseImgUploader").addClass("hidden");var a=$id("qsePreview");var b=qse.GetContent();a.srcdoc=bbcode.render(b)}else{$id("qsePreview").addClass("hidden");$id("qseArea").removeClass("hidden");$id("qseImgUploader").removeClass("hidden")}}},Parser:(new Showdown.converter(conv_opts)).makeBBCode,Uploader:{Init:function(){var b=$id("qseFileSelect"),a=$id("qseMain");if(b.addEventListener){b.addEventListener("change",this.FileSelectHandler,false)}else{b.attachEvent("change",this.FileSelectHandler)}var c=newRequest();if(c.upload){if(document.body.addEventListener){document.body.addEventListener("dragover",this.DocumentListener,false);document.body.addEventListener("dragleave",this.DocumentListener,false);document.body.addEventListener("drop",this.DocumentListener,false);a.addEventListener("dragover",this.FileDragHover,false);a.addEventListener("dragleave",this.FileDragHover,false);a.addEventListener("drop",this.FileSelectHandler,false)}else{document.body.attachEvent("dragover",this.DocumentListener);document.body.attachEvent("dragleave",this.DocumentListener);document.body.attachEvent("drop",this.DocumentListener);a.attachEvent("dragover",this.FileDragHover,false);a.attachEvent("dragleave",this.FileDragHover,false);a.attachEvent("drop",this.FileSelectHandler,false)}}},DocumentListener:function(a){a.preventDefault();return false},ClickListener:function(){$id("qseClickHere").onclick=function(){$id("qseFileSelect").click()}},FileDragHover:function(a){a.stopPropagation();a.preventDefault();a.type==="dragover"?$id("qseMain").addClass("hover"):$id("qseMain").removeClass("hover");a.type==="dragover"?$id("qseImgUploader").addClass("hover"):$id("qseImgUploader").removeClass("hover")},FileSelectHandler:function(d){qse.Uploader.FileDragHover(d);var c=d.target.files||d.dataTransfer.files;for(var b=0,a;a=c[b];b++){qse.Uploader.ParseFile(a)}},ParseFile:function(a){var b=newRequest(),c=new FormData();c.append("file",a);c.append("policy",upConfig.Policy());c.append("signature",upConfig.Signature());b.open("POST",upConfig.URL,true);if(b.addEventListener){b.addEventListener("error",function(d){console.log(d)},false);b.addEventListener("progress",function(d){Math.round(d.loaded/d.total*100)});b.addEventListener("load",function(d){var f=d.target.status;if(f!==200){console.log(new Error(d.target.status),d.target)}try{var g=JSON.parse(this.responseText);g.absUrl=upConfig.Host+g.url;g.absUri=g.absUrl;var h="http:"+g.absUrl;if(qse.Mode==="markdown"){$id("qseArea").value+="![]("+h+")\n"}else{if(qse.Mode==="bbcode"){$id("qseArea").value+="[img]"+h+"[/img]\n"}else{$id("qseArea").value+="http:"+g.absUrl}}}catch(e){console.log(e)}},false)}else{b.attachEvent("error",function(d){console.log(d)});b.attachEvent("progress",function(d){Math.round(d.loaded/d.total*100)});b.attachEvent("load",function(d){var f=d.target.status;if(f!==200){console.log(new Error(d.target.status),d.target)}try{var g=JSON.parse(this.responseText);g.absUrl=upConfig.Host+g.url;g.absUri=g.absUrl;var h="http:"+g.absUrl;if(qse.Mode==="markdown"){$id("qseArea").value+="![]("+h+")\n"}else{if(qse.Mode==="bbcode"){$id("qseArea").value+="[img]"+h+"[/img]\n"}else{$id("qseArea").value+="http:"+g.absUrl}}}catch(e){console.log(e)}},false)}b.send(c)}},Submitter:function(){$id("qseSubmit").onclick=function(){var a=newRequest();data=new FormData();data.append("content",qse.GetContent());a.open("POST",formDataURL,true);if(a.addEventListener){a.addEventListener("error",function(b){console.log(b)},false);a.addEventListener("load",function(b){var c=b.target.status;if(c!==200){console.log(new Error(b.target.status),b.target)}},false)}else{a.attachEvent("error",function(b){console.log(b)},false);a.attachEvent("load",function(b){var c=b.target.status;if(c!==200){console.log(new Error(b.target.status),b.target)}},false)}}},Init:function(){window.onload=function(){window.localStorage.getItem("qsemode")==="bbcode"?qse.BBCMode():qse.MdMode()};this.Define();this.Editor();this.Switcher();this.Previewer();this.Uploader.ClickListener();if(window.File&&window.FileList&&window.FileReader){this.Uploader.Init()}this.Submitter()}};qse.Init();